---
title: "Biostats - Inference and Diagnostics"
subtitle: Rob Leonard (robleonard@tamu.edu)
output:
  html_document: default
  pdf_document: default
---
# 1) Pilot Study  Patient Recruitment 
**1a) Construct two-sided CI's for pi using AC, J, W and CP methods.**   
```{r}
library(DescTools)
BinomCI(8,12, conf.level = 0.95, method = c("agresti-coul","jeffreys","wilson","clopper-pearson"))
```
**1b) Find the required sample size.**
$n=$$(\frac{Z_{(1-alpha)}\sqrt{p_0(1-p_0)}+Z_{(1-beta)}\sqrt{p_1(1-p_1)}}{\delta})^2$
$n=$$(\frac{Z_{0.95}\sqrt{.6(1-.6)}+Z_{.1}\sqrt{.7(1-.7)}}{.1})^2$
```{r}
(n1 = ((((qnorm(.95))*sqrt(.6*.4))+((-1*qnorm(.1))*sqrt(.7*.3)))/.1)^2)  
```
We would need a sample size of 195 (so 1 more than 194 since we needed slightly over 194).

**1c Recalculate n for a potential 35% dropout rate**
```{r}
(n1/(1-.35))
```
We would need n=300 samples if there is a potential drop out rate of 35%.  (299 might be enough depending on rounding, but a 35% dropout rate for 299 samples is 104.65 which is essentially 105 people with a net of 194 observed.  But we need 195 observed so n=300 is preferable).  

# 2) PTSD Observational Study
**2) Test for an association between PTSD and Gender using Chi Square Test of Independence and Odds Ratio **

1) Pearson Chi Squared Test of Independence
Null Hypothesis is $H_0:$ there is no association between the variables PTSD and Gender (either having PTSD or not and being either Male or Female).
Alternative Hypothesis is $H_a:$ there is an association between the two variables PTSD and Gender.
```{r}
ptsd = matrix(c(40,60,280,156),byrow=TRUE, ncol=2)
colnames(ptsd) = c('Male', 'Female')
rownames(ptsd) = c('PTSD','No PTSD')
ptsd.tb = as.table(ptsd)
chisq.test(ptsd.tb, correct=F)  
```
Check to make sure expected frequencies greater than 5 for all cells.
```{r}
n = 40+60+280+156
sum(ptsd[1,1]+ptsd[1,2])*sum(ptsd[1,1]+ptsd[2,1])/n
sum(ptsd[1,1]+ptsd[1,2])*sum(ptsd[1,2]+ptsd[2,2])/n
sum(ptsd[2,1]+ptsd[2,2])*sum(ptsd[1,1]+ptsd[2,1])/n
sum(ptsd[2,1]+ptsd[2,2])*sum(ptsd[1,2]+ptsd[2,2])/n
```
The high Chi Squared test statistic and very low p-value (< .05%) means that we have significant evidence to reject the null hypothesis that there is not an association between PTSD and Gender.  The condition that the expected cell values all exceed 5 are met, so using Pearson's Chi Squared Test of independence is valid.

2) Now repeat test of no association using the Odds Ratio Method
```{r}
tausq = 1/40+1/60+1/280+1/156   # get variance using large sample approximation which is sum 1/frequencies
sdtau = sqrt(tausq)   # get std dev for CI
or = (40*156)/(60*280)
lor = log(or)
(lor-qnorm(.975)*sdtau)  # lower bound
(lor+qnorm(.975)*sdtau)   # upper bound
```
The confidence interval for the log odds ratio is (-1.435,-0.545).  Since this interval does not include 0 which is the null hypothesis value for the log(OR), we have significant evidence to reject the null hypothesis that there is not an association between PTSD and Gender.
So both the Chi Squared and Odds Ratio methods reach the same conclusion, to reject the null hypotheses.  There is evidence of an association between PTSD and Gender.

# 3) Pima Indian Dataset
**Load data and scale variables **
```{r}
library(MASS)
data("Pima.tr")
ScaledData=(Pima.tr)
ScaledData$glu=scale(ScaledData$glu)
ScaledData$bp=scale(ScaledData$bp)
ScaledData$bmi=scale(ScaledData$bmi)
ScaledData$ped=scale(ScaledData$ped)
ScaledData$age=scale(ScaledData$age)
```
**3a) Test if age is positively associated with the disease **
```{r}
model3 = glm(type~npreg+glu+bp+skin+bmi+ped+age, data=ScaledData, family="binomial")
summary(model3)
# test if age is positively associated with type, so a 1-sided test
qt(.95,192)
```
Yes, there is a positive association between age and type.  The null hypotheses is $H_0: \beta_7 <=0$ No positive association between Age and Type (chances of having the disease) controlling for the other variables versus the alternative hypothesis of $H_a:\beta_7 >0$ a positive association between age and type.  The t-test statistic is shown in the summary table as 1.864 and the t-critical value for a 1-sided hypothesis test at the usual $\alpha$=.05 level is 1.65.  The test statistic is greater than the critical value which indicates that we have sufficient evidence to reject the null hypothesis that there is not any non positive association between age and type.

**3b) Test that the coefficients for skin, bp and bmi are all 0 using likelihood and Wald at alpha=0.05.**
Likelihood Ratio Test First
$H_0: \beta_3 = \beta_4 = \beta_5 =0$ versus $H_a:$ at least one non-zero.
```{r}
library(lmtest)
model3alt = glm(type~npreg+glu+ped+age, data=ScaledData, family="binomial")
lrtest(model3,model3alt) # using R functions
# or calculate by hand
diff01 = as.numeric(logLik(model3alt))-as.numeric(logLik(model3)) #loglik rest-unrest
teststat1 = -2*diff01
df1 = df.residual(model3alt)-df.residual(model3)
pval1 = 1-pchisq(teststat1, df1)  
cat('P-value calcualted by hand', pval1) # p-value calculated by hand
```
The p-value of 0.096 is more than .05, indicates we do not have significant evidence to reject the null hypothesis that all three coefficients are equal to zero.  

Recheck using Wald.
```{r}
library(aod)
wald.test(b=coef(model3), Sigma = vcov(model3), Terms= 4:6)
```
The Wald test results concur with the likelihood ratio test.  At the 5% level, the p-value from the Wald test of 0.11 means we cannot reject the null hypothesis.

**3c) Provide a Cook's distance plot and check if there are any influential observations.**
```{r}
plot(cooks.distance(model3), type="h")
points(cooks.distance(model3), pch=21, col="blue", bg=2)
summary(cooks.distance(model3))
abline(h=.0285)  #3*iqr +3rd quartile
which(cooks.distance(model3)>.0285)
```
Observations (8,9,104,111,132,175,190) are possible influential observations.

**3d) New model and employ stepwise regression.**
```{r}
model3d = glm(type~npreg+glu+ped+age+I(age*age)+I(ped*age)+I(glu*age)+I(glu*ped), data=ScaledData, family="binomial")
summary(model3d)
# stepwise
library(MASS)
model3d.min = glm(type~1, data=ScaledData, family="binomial")  # null model
out3d.both = step(model3d.min, scope=list(lower=model3d.min, upper=model3d))
```
The best fitting model is:
$logit(P(Type=1 |glu,age,ped,ped*age,age^2))$
$= \beta_0 +\beta_1 (Glu)+\beta_2 (Age) +\beta_3 (Ped)+\beta_4 (Ped*Age)+\beta_5 (Age^2)+e$



